---
title: "Brachy exploratory plots"
author: "Martin van Rongen"
date: "2019-05-01"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Loading libraries and settings

Load the relevant libraries and change some default plotting settings

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
theme_set(theme_bw())
scale_colour_discrete <- function(...) scale_color_brewer(palette = "Dark2")
scale_fill_discrete <- function(...) scale_fill_brewer(palette = "Dark2")
```


> Distribution of the trait data
> Think about statistics

## Read in clean data

To ensure that the data is read in correctly, the `.csv` file that was created previously is read in using the `read_csv` command. This way a tibble is created where the column specification is as basic as possible. This helps to avoid unnecessary factor conversions.

**Note:** Exclude Bd21-3 filler plants?

```{r}
ril_phenotypes <- read_csv("../../data/processed/ril_phenotypes/ril_phenotypic_data.csv")
```

## HN/LN branching by batch

Scatter plot of number of shoots at `z68_shoots` by `ril_id` and `nitrate_level`:

```{r}
ril_phenotypes %>%
  group_by(batch, nitrate_level) %>% 
  filter(!is.na(z68_shoots)) %>% 

ggplot(., aes(x = ril_id, y = z68_shoots, colour = nitrate_level)) +
    labs(title = "Branch number at z68 stage", 
       subtitle = "Per batch by nitrate level", 
       x = "Genotype (by ril_id)", 
       y = "Branches") +
  geom_point() +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", alpha = 0.7) +
  facet_wrap(. ~ batch, ncol = 4) +
  
  theme(
    axis.text.x = element_blank()
  )
```

The plot above shows that overall the number of branches on LN is much lower than on HN. The variation of branch number appears to be lower on LN than on HN as well.

Checking this for each batch.

Furthermore, highlighting the parental and Bd21-3 filler lines. There seems to be a lot of variation in the level of branching within each batch for Bd21-3 (orange points).

This means that there is probably going to be a high level of variation in (mean) plasticity too.


```{r}
ril_phenotypes %>%
  filter(!is.na(z68_shoots)) %>% 
  mutate(ril_id = reorder(ril_id, z68_shoots)) %>% 

ggplot(., aes(x = ril_id, y = z68_shoots, colour = nitrate_level)) +
      labs(title = "Branch number at z68 stage", 
       subtitle = "Per batch split by nitrate level", 
       x = "Genotype (by ril_id)", 
       y = "Branches") +
  geom_point() +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", alpha = 0.7) +
  facet_grid(nitrate_level ~ batch) +
  
  theme(legend.position = "none",
        axis.text.x = element_blank())
```

### Mean branching per genotype on HN or LN

Calculating the average number of branches per genotype on HN and LN.

```{r}
plot_df <- ril_phenotypes %>%
  group_by(nitrate_level, ril_id) %>% 
  select(batch, id, ril_id, nitrate_level, z68_shoots) %>% 
  filter(!is.na(z68_shoots)) %>% 
  summarise(n = n(),
            avg_branching = mean(z68_shoots),
            sd = sd(z68_shoots),
            se = sd / sqrt(n),
            ci = 2 * se) %>% 
  do(
  plots = ggplot(., aes(x = fct_reorder(ril_id, avg_branching), y = avg_branching )) +
    labs(title = (paste0("Mean branching on ",.$nitrate_level)),
       subtitle = "Mean per genotype (with 95% CI)",
       x = "Genotype (reordered)", 
       y = "Branches (mean)") +
  expand_limits(y = 0) +
  geom_jitter() +
  geom_errorbar(aes(ymin = avg_branching - ci, ymax = avg_branching + ci), width = 0.1) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  
  theme(axis.text.x = element_blank(),
        legend.position = "none")
  )

plot_df$plots
```

## Branching plasticity

### Plasticity per genotype per batch

How about branching plasticity?
Plotting the plasticity (= number of branches on HN - number of branches on LN) and reordering by low to high plasticity. Using `geom_jitter()` since many RILs have the same plasticity (it's not a continuous variable).

The following lines are highlighted:

* Bd3-1 (magenta)
* Bd21 (blue)
* Bd21-3 (orange)

**Averaging multiple RIL entries**

> Each batch, nitrate_level, ril_id summarise with the mean. In most cases there's one data point. For ones that appear more than once (e.g. Bd21-3 or a filler replacement) there will be an average of those values. From *that* table you can spread by nitrate_level because in that table the ril_id will be unique per genotype per batch (CHECK if each ril_id occurs the same number of times as the number of batches).

> NOTE! This does not "save" the lost values from plants that died. For example, RIL025 in batch 1 on LN died, so an extra RIL025 was included in batch 3, but it's not possible to just substitute the value from batch 3 into batch 1 and then calculate the plasticity.


```{r results = "hide", fig.keep = "all"}

plot_df <- ril_phenotypes %>%
  group_by(batch, nitrate_level, ril_id) %>% 
  summarise(z68_shoots_mean = mean(z68_shoots)) %>% 
  spread(nitrate_level, z68_shoots_mean) %>% 
  mutate(plasticity = HN - LN) %>% 
  filter(!is.na(plasticity)) %>% 
  
  do(
plots = ggplot(., aes(x = reorder(ril_id, plasticity), y = plasticity)) + 
  labs(title = (paste0("Branching plasticity for batch ",.$batch)), 
       subtitle = "Reordered from low to high", 
       x = "Genotype (reordered)", 
       y = "Branching plasticity") +
  expand_limits(y = 0) +
  geom_jitter() +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", alpha = 0.7) +
  
  theme(axis.text.x = element_blank()))

plot_df$plots
```

**Comments**

The average branching plasticity for Bd21-3 varies somewhat between batches. Sometimes it is greater than Bd3-1, but sometimes it is less.

Branching plasticity in Bd3-1 is consistently higher than Bd21 across all tested batches (1-4).


### Overall plasticity per batch

To see if there's an overall batch effect on plasticity, the plasticity is plotted for each batch as a summary statistic in the form of a `boxplot`.

**Note:** the average number of shoots on HN/LN is calculated for RILs that occur more than once in each batch/treatment combination.

```{r}
ril_phenotypes %>%
  group_by(batch, nitrate_level, ril_id) %>% 
  summarise(z68_shoots_mean = mean(z68_shoots)) %>% 
  spread(nitrate_level, z68_shoots_mean) %>% 
  mutate(plasticity = HN - LN) %>% 
  filter(!is.na(plasticity)) %>% 
  
  ggplot(., aes(x = as.factor(batch), y = plasticity, fill = as.factor(batch))) +
    labs(title = "Branching plasticity by batch",
       x = "Batch number", 
       y = "Branching plasticity") +
  expand_limits(y = 0) +
  geom_boxplot() +
  
  theme(legend.position = "none")
```

**Comments**

The overall branching plasticity appears to be higher in batches 3 and 4, compared to batches 1 and 2.

### Mean plasticity across batches

```{r}
ril_phenotypes %>%
  group_by(batch, nitrate_level, ril_id) %>% 
  summarise(z68_shoots_mean = mean(z68_shoots)) %>% 
  spread(nitrate_level, z68_shoots_mean) %>% 
  mutate(plasticity = HN - LN) %>% 
  filter(!is.na(plasticity)) %>% 
  ungroup() %>% 
  group_by(ril_id) %>%
  summarise(n = n(),
            avg_plasticity = mean(plasticity),
            sd = sd(plasticity),
            se = sd / sqrt(n),
            ci = 2 * se) %>% 
  
  ggplot(., aes(x = fct_reorder(ril_id, avg_plasticity), y = avg_plasticity )) +
  labs(title = "Branching plasticity (low to high)",
       subtitle = "Mean per genotype (with 95% CI)",
       x = "Genotype (reordered)", 
       y = "Branching plasticity (mean)") +
  geom_jitter() +
  geom_errorbar(aes(ymin = avg_plasticity - ci, ymax = avg_plasticity + ci), width = 0.1) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

**Comments**

2019-04-30: There is considerable variation between batches, at least when only the first 4 batches are taken into account.

## Flowering time

### Flowering time & branching

Scatter plot of number of shoots at `z68_shoots` vs 'flowering_time' per `batch`. Using `geom_jitter` because otherwise many points overlap.

```{r}
ril_phenotypes %>%

ggplot(., aes(x = flowering_time, y = z68_shoots, colour = nitrate_level)) +
    labs(title = "Flowering time vs branching", 
       subtitle = "By batch and nitrate level", 
       x = "Flowering time (days)", 
       y = "Branches") +
  geom_jitter() +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", alpha = 0.3) +
  facet_wrap(. ~ batch, ncol = 4)
```

**Comments**

There seems to be a positive correlation between branching and flowering time on HN. Explore this further by looking at the average branching and flowering time.

### Flowering time and branching across all batches

Using `geom_jitter` because otherwise many points overlap.

```{r}
ril_phenotypes %>%

ggplot(., aes(x = flowering_time, y = z68_shoots, colour = nitrate_level)) +
    labs(title = "Flowering time vs branching", 
       subtitle = "By nitrate level", 
       x = "Flowering time (days)", 
       y = "Branches") +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", alpha = 0.5) +
  facet_wrap(. ~ nitrate_level) +
  
  theme(
    legend.position = "none"
  )
```

### Average flowering time and branching across all batches

```{r}
ril_phenotypes %>%
  group_by(ril_id, nitrate_level) %>% 
  summarise(avg_z68_shoots = mean(z68_shoots),
            avg_flowering_time = mean(flowering_time)) %>% 

ggplot(., aes(x = avg_flowering_time, y = avg_z68_shoots, colour = nitrate_level)) +
    labs(title = "Average flowering time vs average branching", 
       subtitle = "By nitrate level for each genotype", 
       x = "Flowering time (days)", 
       y = "Branches") +
  geom_point() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  facet_wrap(. ~ nitrate_level) +
  
  theme(
    legend.position = "none"
  )
```

### Average flowering time and SPAD across all batches

```{r}
ril_phenotypes %>%
  group_by(ril_id, nitrate_level) %>% 
  filter(!is.na(z68_greenness)) %>% 
  summarise(avg_greenness = mean(z68_greenness),
            avg_flowering_time = mean(flowering_time)) %>% 

ggplot(., aes(x = avg_flowering_time, y = avg_greenness, colour = nitrate_level)) +
    labs(title = "Average flowering time vs average SPAD", 
       subtitle = "By nitrate level for each genotype", 
       x = "SPAD score", 
       y = "Flowering time (days)") +
  geom_point() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  facet_wrap(. ~ nitrate_level) +
  
  theme(
    legend.position = "none"
  )
```

### Flowering time plasticity

```{r}
ril_phenotypes %>%
  group_by(ril_id, batch, nitrate_level) %>% 
  summarise(avg_flowering_time = mean(flowering_time)) %>% 
  spread(nitrate_level, avg_flowering_time) %>% 
  mutate(flowering_time_plasticity = HN - LN) %>% 
  filter(!is.na(flowering_time_plasticity)) %>% 
  
  ggplot(., aes(x = ril_id, y = flowering_time_plasticity)) +
  labs(title = "Flowering time plasticity",
       subtitle = "Average for each genotype per batch",
       x = "Genotype (ril_id)", 
       y = "Flowering time plasticity (mean)") +
  geom_point() +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

### Average flowering time plasticity

```{r}
ril_phenotypes %>%
  group_by(batch, nitrate_level, ril_id) %>% 
  summarise(avg_flowering_time = mean(flowering_time)) %>% 
  spread(nitrate_level, avg_flowering_time) %>% 
  mutate(flowering_time_plasticity = HN - LN) %>% 
  filter(!is.na(flowering_time_plasticity)) %>% 
  ungroup() %>% 
  group_by(ril_id) %>%
  summarise(n = n(),
            avg_flowering_time_plasticity = mean(flowering_time_plasticity),
            sd = sd(flowering_time_plasticity),
            se = sd / sqrt(n),
            ci = 2 * se) %>% 
  
  ggplot(., aes(x = fct_reorder(ril_id, avg_flowering_time_plasticity), y = avg_flowering_time_plasticity )) +
  labs(title = "Flowering time plasticity (low to high)",
       subtitle = "Mean per genotype (with 95% CI)",
       x = "Genotype (reordered)", 
       y = "Flowering time plasticity (mean)") +
  geom_point() +
  geom_errorbar(aes(ymin = avg_flowering_time_plasticity - ci, ymax = avg_flowering_time_plasticity + ci), width = 0.1) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

### Per batch by nitrate level

Plotting the number of branches against the time it took to reach the Z68 stage.
Added a regression line.

```{r}
ril_phenotypes %>%
  filter(!is.na(z68_shoots)) %>% 

ggplot(., aes(x = flowering_time, y = z68_shoots, colour = nitrate_level)) +
  labs(title = "Branch number vs days to z68", 
       subtitle = "Per batch by nitrate level", 
       x = "Days to z68", 
       y = "Branches") +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  facet_grid(batch ~ nitrate_level) +
  
  theme(legend.position = "none")
```

**Comments**

It looks as if there's a weak positive correlation between branch number and days to z68 when plants are grown on HN.

Next, plotting this across the batches by calculating the mean number of branches per genotype.

### Average across batches

Calculating the following:

* Mean number of branches per genotype
* Mean number of days to z68 per genotype

```{r}
ril_phenotypes %>%
  filter(!is.na(z68_shoots)) %>% 
  group_by(ril_id, nitrate_level) %>% 
  summarise(avg_z68_shoots = mean(z68_shoots),
            avg_flowering_time = mean(flowering_time)) %>% 
  
  ggplot(., aes(x = avg_flowering_time, y = avg_z68_shoots, colour = nitrate_level)) +
  labs(title = "Branch number vs days to z68", 
       subtitle = "Mean across batches for each nitrate level", 
       x = "Days to z68 (mean)", 
       y = "Branches (mean)") +
  expand_limits(y = 0) +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  facet_grid(. ~ nitrate_level) +
  
  theme(legend.position = "none")
```

**Comments**

There appears to be a positive correlation on HN for the number of days it takes a plant to reach the Z68 stage and the mean number of branches it produces.

> Explore this further

## Seed weight vs branches

### Per batch by nitrate level

Checking if the total seed weight is correlated to the number of branches.

```{r}
ril_phenotypes %>%
  filter(!is.na(z68_shoots)) %>% 

ggplot(., aes(x = seed_weight_g, y = z68_shoots, colour = nitrate_level)) +
    labs(title = "Branch number vs seed weight",
         subtitle = "Per batch by nitrate level",
         x = "Seed weight (g)",
         y = "Branches") +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  facet_grid(batch ~ nitrate_level) +
  
  theme(legend.position = "none")
```

**Comments**

There appears to be no correlation between seed weight per plant and the number of branches.

### Mean seed weight across batches

```{r}
ril_phenotypes %>%
  filter(!is.na(z68_shoots), !is.na(seed_weight_g)) %>% 
  group_by(ril_id, nitrate_level) %>% 
  summarise(avg_z68_shoots = mean(z68_shoots),
            avg_seed_weight_g = mean(seed_weight_g)) %>% 
  
  ggplot(., aes(x = avg_seed_weight_g, y = avg_z68_shoots, colour = nitrate_level)) +
  labs(title = "Branch number vs seed weight", 
       subtitle = "Mean across batches for each nitrate level", 
       x = "Mean seed weight (g)", 
       y = "Branches (mean)") +
  expand_limits(y = 0) +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
    geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  facet_grid(. ~ nitrate_level) +
  
  theme(legend.position = "none")
```

### Mean seed weight vs senescence

```{r}
ril_phenotypes %>%
  filter(!is.na(lifespan), !is.na(seed_weight_g)) %>% 
  group_by(ril_id, nitrate_level) %>% 
  summarise(avg_lifespan = mean(lifespan),
            avg_seed_weight_g = mean(seed_weight_g)) %>% 
  
  ggplot(., aes(x = avg_seed_weight_g, y = avg_lifespan, colour = nitrate_level)) +
  labs(title = "Seed weight vs lifespan", 
       subtitle = "Mean across batches for each nitrate level", 
       x = "Mean seed weight (g)", 
       y = "Lifespan (days)") +
  expand_limits(y = 0) +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
    geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  facet_grid(. ~ nitrate_level) +
  
  theme(legend.position = "none")
```

## Greenness (SPAD)

### Per batch by nitrate level for each RIL

```{r}
ril_phenotypes %>% 
  filter(!is.na(z68_greenness)) %>% 
  
  ggplot(., aes(x = ril_id, y = z68_greenness, colour = nitrate_level)) +
    labs(title = "SPAD score per RIL",
         subtitle = "Per batch by nitrate level",
         x = "Genotype",
         y = "SPAD score") +
  geom_jitter() +
  facet_grid(batch ~ nitrate_level) +
  
  theme(legend.position = "none",
        axis.text.x = element_blank())
```

**Comments**

The SPAD scores appear to be pretty evenly distributed across the RILs.
They seem to be a little lower on LN than on HN.

Exploring this further.

### SPAD per batch by nitrate level

Checking the overall SPAD score per batch for each nitrate level.

```{r}
ril_phenotypes %>% 
  filter(!is.na(z68_greenness)) %>% 
  
  ggplot(., aes(x = nitrate_level, y = z68_greenness, fill = nitrate_level)) +
  labs(title = "SPAD score per batch",
         subtitle = "By nitrate level",
         x = "Nitrate level",
         y = "SPAD score") +
  geom_boxplot() +
  facet_grid(. ~ batch) +
  
  theme(legend.position = "none")
```

**Comments**

The SPAD score appears to be consistently lower on LN than on HN.
Across batches the overall SPAD score range is fairly consistent.

### SPAD score vs branching

Is there a correlation between SPAD score and number of branches?
Using `geom_jitter` because there are quite a few measurements that have the same SPAD score and these points then overlap.

```{r}
ril_phenotypes %>% 
  filter(!is.na(z68_greenness)) %>% 
  
  ggplot(., aes(x = z68_greenness, y = z68_shoots, colour = nitrate_level)) +
  labs(title = "Branch number vs SPAD score", 
       subtitle = "Per batch for each nitrate level", 
       x = "SPAD score", 
       y = "Branches") +
  geom_jitter() +
  facet_grid(batch ~ nitrate_level) +
  
  theme(legend.position = "none")
```

**Comments**

There does not seem to be a correlation between the number of branches a plant forms and its SPAD score.

### Mean SPAD score vs branches across batches

```{r}
ril_phenotypes %>%
  filter(!is.na(z68_shoots), !is.na(z68_greenness)) %>% 
  group_by(ril_id, nitrate_level) %>% 
  summarise(avg_z68_shoots = mean(z68_shoots),
            avg_z68_greenness = mean(z68_greenness)) %>% 
  
  ggplot(., aes(x = avg_z68_greenness, y = avg_z68_shoots, colour = nitrate_level)) +
  labs(title = "Branch number vs SPAD score", 
       subtitle = "Mean across batches for each nitrate level", 
       x = "Mean SPAD score", 
       y = "Branches (mean)") +
  expand_limits(y = 0) +
  geom_jitter() +
  geom_smooth(method = "lm", colour = "black", size = .5) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  facet_grid(. ~ nitrate_level) +
  
  theme(legend.position = "none")
```

**Comments**

There definitely does not seem to be a correlation between branch number and SPAD score.

## Plant height

### Per batch for each nitrate level

Plotting the plant height (cm) for all genotypes per batch for each nitrate level. This to see whether plant height varies across batches and if it is affected by nitrate availability.

```{r}
ril_phenotypes %>% 
  filter(!is.na(senescence_height)) %>% 
  
  ggplot(., aes(x = ril_id, y = senescence_height, colour = nitrate_level)) +
  labs(title = "Plant height", 
       subtitle = "Per batch for each nitrate level", 
       x = "Genotype", 
       y = "Plant height (cm)") +
  expand_limits(y = 0) +
  geom_jitter() +
  facet_grid(batch ~ nitrate_level) +
  
  theme(legend.position = "none",
        axis.text.x = element_blank())
```

**Comments**

Plant height seems to vary a bit between batches (e.g. height in batch 3 seems somewhat higher than in batches 1, 2 and 4) and there does not seem to be much of an effect of nitrate availability on plant height.

To look at this a bit more, plotting these data as a boxplot.

### Per batch for each nitrate level (boxplot)

```{r}
ril_phenotypes %>% 
  filter(!is.na(lifespan)) %>% 
  
  ggplot(., aes(x = nitrate_level, y = senescence_height, fill = nitrate_level)) +
  labs(title = "Plant height", 
       subtitle = "Per batch for each nitrate level", 
       x = "Nitrate level",
       y = "Plant height (cm)") +
  expand_limits(y = 0) +
  geom_boxplot() +
  facet_grid(. ~ batch) +
  
  theme(legend.position = "none")
```

**Comments**

Little effect of nitrate level on plant height (apart from maybe in batch 4). Across batches plant height varies.

> Check again once all the data is available.

> Check how this relates to Arabidopsis

### Mean height across batches

```{r}
ril_phenotypes %>%
  filter(!is.na(senescence_height)) %>% 
  group_by(ril_id, nitrate_level) %>% 
  summarise(avg_senescence_height = mean(senescence_height)) %>% 
  
  ggplot(., aes(x = fct_reorder(ril_id, avg_senescence_height), y = avg_senescence_height, colour = nitrate_level)) +
  labs(title = "Plant height per RIL", 
       subtitle = "Mean across batches for each nitrate level", 
       x = "Genotype (reordered)", 
       y = "Mean plant height (cm)") +
  expand_limits(y = 0) +
  geom_jitter() +
  facet_grid(. ~ nitrate_level) +
  geom_point(data = . %>%  filter(ril_id == "Bd3-1"), colour = "magenta", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21"), colour = "royalblue3", size = 3, alpha = 0.7) +
  geom_point(data = . %>%  filter(ril_id == "Bd21-3"), colour = "orange", size = 3, alpha = 0.7) +
  
  theme(legend.position = "none",
        axis.text.x = element_blank())
```

**Comments**

This plot shows that there is quite a range of plant heights across the RILs. The parental lines are far apart from one another, both on HN and LN (with Bd3-1 being taller than Bd21). The standard wild type Bd21-3 is similar to Bd21. Is Bd21-3 derived from Bd21?

It looks as if Bd21 is taller on LN than on HN and that height for Bd3-1 is negatively affected by LN. Plotting this.

### Plant height response in parental and wild type lines

> These are called reaction-norm plots

Plotting this as a line plot. Note: many height measurements are missing for Bd21-3, so there are few pairs. Filtering these out, since we're interesting in looking at changes across treatment.

```{r}
ril_phenotypes %>% 
  filter(!is.na(senescence_height)) %>% 
  filter(ril_id %in% c("Bd3-1", "Bd21", "Bd21-3")) %>% 
  select(batch, id, ril_id, nitrate_level, senescence_height) %>% 
  group_by(batch, id) %>% 
  # Filter out values that have no paired observation
  filter(n() > 1) %>% 
  
  ggplot(., aes(x = nitrate_level, y = senescence_height, label = id)) +
    labs(title = "Plant height response to nitrate", 
       subtitle = "Response per genotype", 
       x = "Nitrate level", 
       y = "Plant height (cm)") +
  expand_limits(y = 0) +
  geom_point() +
  geom_line(aes(group = interaction(batch, id))) +
  facet_grid(. ~ ril_id)
```

**Comments**

Overall it appears that the plant height of parental/control lines respond as follows:

* Bd21 height increases in response to LN
* Bd21-3 height generally increases in response to LN, with a few exceptions
* Bd3-1 height decreases in response to LN

## Time-related

### Life span

See how the RIL life span is distributed between treatments.

**Note** The lifespan is capped at < 100, because there are some strange outliers in batch 6 that obscure the rest of the data.

```{r}
ril_phenotypes %>% 
  filter(lifespan < 100) %>% 
  
  ggplot(., aes(x = ril_id, y = lifespan, colour = nitrate_level)) +
  labs(title = "RIL life span", 
       subtitle = "Per genotype for each nitrate level", 
       x = "Genotype", 
       y = "Lifespan (days)") +
  geom_jitter() +
  facet_grid(. ~ nitrate_level) +
  
  theme(legend.position = "none",
        axis.text.x = element_blank())
```

**Comments**

The plants grown on LN appear to have a wider life span range than the ones grown on HN. Also, the life span of HN-grown plants appears to be higher.

Need to check if this trend is clear in all batches.

### Life span per batch

Checking the life span per batch

```{r}
ril_phenotypes %>% 
  filter(!is.na(lifespan)) %>% 
  
  ggplot(., aes(x = nitrate_level, y = lifespan, fill = nitrate_level)) +
  labs(title = "RIL life span", 
       subtitle = "Per batch for each nitrate level", 
       x = "Nitrate level", 
       y = "Lifespan (days)") +
  geom_boxplot() +
  facet_grid(. ~ batch) +
  
  theme(legend.position = "none")
```

**Comments**

It does look like the overall life span of plants grown on LN is shorter than that of plants grown on HN. This trend is visible in most batches, but not so in batch 1.

## Checking for positional effects

It is possible that some traits are affected by the position in which the plants were grown.

To test this, traits can be plotted by position using `geom_tile`, which creates a sort of heat map of the trait based on position.

### Flowering time and position

```{r}
# by position e.g A1, H2
# separate columns, with leading zero
ril_phenotypes %>% 
  mutate(col_pos = str_remove(position_grid_location, 
                              "[A-Z]"),
         row_pos = str_remove(position_grid_location, 
                              "[0-9]+")) %>% 
  ggplot(aes(col_pos, row_pos, fill = flowering_time)) +
    labs(title = "Flowering time by position", 
       subtitle = "Per batch for each nitrate level", 
       x = "Column", 
       y = "Row") +
  geom_tile() +
  facet_grid(batch ~ nitrate_level)
```

### Branching and position

```{r}
# by position e.g A1, H2
# separate columns, with leading zero
ril_phenotypes %>% 
  mutate(col_pos = str_remove(position_grid_location, 
                              "[A-Z]"),
         row_pos = str_remove(position_grid_location, 
                              "[0-9]+")) %>% 
  ggplot(aes(col_pos, row_pos, fill = z68_shoots)) +
    labs(title = "Branch number by position", 
       subtitle = "Per batch for each nitrate level", 
       x = "Column", 
       y = "Row") +
  geom_tile() +
  facet_grid(batch ~ nitrate_level)
```

**Comments**

There does not seems to be any obvious pattern in the flowering time based on position. Overall flowering appears to occur faster on HN than it does on LN.

Branching on HN is clearly higher than on LN, but again there does not seems to be an obvious pattern in relation to the grid. This suggests that there are no obvious positional effects to branching.

> Should follow up a bit more on this, maybe check the average across rows/columns to rule out edge effects.

## Checking for seasonal effects

> Are other traits affected by season? Look at flowering etc.

> Conviron logs for chamber?

